<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>University of Edu — Rate Staff</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--nav-width:220px;--brand:#003366;--accent:#cc0000;--muted:#6b7280}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif}
    body{background:#f4f4f4;min-height:100vh}
    .sidebar{width:var(--nav-width);background:var(--brand);color:#fff;height:100vh;position:fixed;top:0;left:0;padding-top:20px}
    .sidebar h2{text-align:center;color:var(--accent);margin-bottom:18px;font-size:18px}
    .sidebar a{display:block;color:#fff;padding:12px 18px;text-decoration:none;font-weight:600}
    .header-bar{margin-left:var(--nav-width);background:#fff;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #e6e9ee;position:sticky;top:0;z-index:10}
    .header-left{display:flex;align-items:center;gap:12px}
    .header-left img{width:40px;height:40px;object-fit:contain}
    .header-left span{font-size:20px;font-weight:800;color:var(--brand)}
    .top-menu{margin-left:var(--nav-width);background:var(--brand);padding:8px 20px;display:flex;gap:20px;justify-content:center}
    .welcome-banner{margin-left:var(--nav-width);margin-top:10px;height:96px;background-image:url('https://img.freepik.com/free-photo/students-studying-together-medium-shot_23-2148913227.jpg');background-size:cover;background-position:center;display:flex;align-items:center;justify-content:center;border-radius:6px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .welcome-text{color:#fff;font-size:26px;font-weight:900;background:rgba(0,0,0,0.45);padding:10px 16px;border-radius:6px}
    .main{margin-left:var(--nav-width);padding:20px}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.04);margin-bottom:16px}
    .rate-section{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:12px}
    .profile-box{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.04);display:flex;flex-direction:column;gap:12px}
    .profile-box img{width:100%;height:220px;object-fit:cover;border-radius:8px}
    .profile-details h2{color:var(--brand);margin-bottom:6px;font-size:20px}
    .bio{margin-top:10px;color:#333;font-style:italic}
    .rating-form{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    .compact .row{display:flex;gap:10px;align-items:center;margin:8px 0}
    .compact label{min-width:160px;font-weight:600;color:#333}
    textarea{width:100%;min-height:120px;padding:10px;border:1px solid #e6e9ee;border-radius:6px}
    .small-note{font-size:13px;color:var(--muted);margin-top:8px}
    .btn{padding:10px 14px;background:var(--accent);color:#fff;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn.secondary{background:var(--brand)}
    .history-table{width:100%;border-collapse:collapse;margin-top:8px}
    .history-table th,.history-table td{padding:10px;border-bottom:1px solid #eef2f6;text-align:left;font-size:14px}
    .history-table th{background:#fbfdff;color:var(--brand);font-weight:700}
    .error{color:#b91c1c;margin-top:12px;font-weight:700}
    @media(max-width:920px){.rate-section{grid-template-columns:1fr}.profile-box img{height:160px}}
  </style>
</head>
<body>
  <nav class="sidebar">
    <h2>Admin Panel</h2>
    <a href="control-center.html">Dashboard</a>
    <a href="all-employees.html">All Employees</a>
    <a href="configure-criteria.html">Configure Criteria</a>
    <a href="manage-users.html">Manage Users</a>
    <a href="rate-staff.html" id="rateStaffLink">Rate Staff</a>
    <a href="reports.html">Reports</a>
    <a href="settings.html">Settings</a>
  </nav>

  <header class="header-bar">
    <div class="header-left">
      <img src="https://static.vecteezy.com/system/resources/thumbnails/006/470/455/small_2x/university-education-logo-design-template-vector.jpg" alt="University Logo" />
      <span>University of Edu — Staff Rating Portal</span>
    </div>
    <div class="header-right">
      <a href="login.html" id="logoutBtn">Log Out</a>
    </div>
  </header>

  <div class="top-menu">
    <a href="about.html">About</a>
    <a href="events.html">Events/Activities</a>
    <a href="all-employees.html">View All Employees</a>
    <a href="reports.html">View Reports</a>
  </div>

  <section class="welcome-banner">
    <div class="welcome-text">Rate Staff</div>
  </section>

  <main class="main">
    <section class="card">
      <h3 style="margin:0 0 10px;color:var(--accent)">Submit Rating</h3>
      <div class="rate-section">
        <div class="profile-box" id="staffProfileBox">
          <img id="staffPhoto" src="https://i.pravatar.cc/400?img=12" alt="Staff Photo" />
          <div class="profile-details">
            <h2 id="staffName">Loading...</h2>
            <div><strong>Department:</strong> <span id="staffDept">—</span></div>
            <div><strong>Email:</strong> <span id="staffEmail">—</span></div>
            <div><strong>Phone:</strong> <span id="staffPhone">—</span></div>
            <div class="bio" id="staffBio">—</div>
            <div style="margin-top:8px">
              <button class="btn secondary" id="viewHistoryBtn" aria-controls="historySection" aria-expanded="false">View Rating History</button>
              <button class="btn" id="openReportBtn" style="margin-left:8px">Open Employee Report</button>
            </div>
          </div>
        </div>

        <div class="rating-form" id="ratingFormArea">
          <h4>Submit Rating for <span id="rateForName">—</span></h4>

          <div class="compact">
            <div class="row">
              <label>Clarity of instruction</label>
              <div class="stars">
                <label><input type="radio" name="c1" value="1" required>1</label>
                <label><input type="radio" name="c1" value="2">2</label>
                <label><input type="radio" name="c1" value="3">3</label>
                <label><input type="radio" name="c1" value="4">4</label>
                <label><input type="radio" name="c1" value="5">5</label>
              </div>
            </div>

            <div class="row">
              <label>Knowledge of subject</label>
              <div class="stars">
                <label><input type="radio" name="c2" value="1" required>1</label>
                <label><input type="radio" name="c2" value="2">2</label>
                <label><input type="radio" name="c2" value="3">3</label>
                <label><input type="radio" name="c2" value="4">4</label>
                <label><input type="radio" name="c2" value="5">5</label>
              </div>
            </div>
          </div>

          <div style="margin-top:12px">
            <label for="comment">Comments (optional)</label>
            <textarea id="comment" placeholder="Write constructive feedback..."></textarea>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <label><input type="checkbox" id="anon"> Submit anonymously</label>
            <div style="flex:1"></div>
            <button class="btn" id="submitRatingBtn">Submit Rating</button>
          </div>

          <div id="errorMsg" class="error" style="display:none">Cannot rate same staff twice in this session.</div>
          <div id="ratingMsg" class="small-note" style="margin-top:12px;color:var(--muted)"></div>
        </div>
      </div>
    </section>

    <section class="card" id="historySection" style="display:none">
      <h3>Rating History — <span id="historyFor">—</span></h3>
      <table class="history-table">
        <thead><tr><th>Date</th><th>Criteria</th><th>Score</th><th>Comments</th></tr></thead>
        <tbody id="ratingsBody">
          <tr><td colspan="4" style="text-align:center;color:var(--muted)">No ratings yet</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <footer style="margin-left:var(--nav-width);padding:12px;text-align:center;color:#666">
    © 2025 University of Edu — Design by Barnabas Blessing
  </footer>

  <script>
  // Safe DOM helper
  const $ = (id) => document.getElementById(id);

  // sidebar toggle (only attach if element exists)
  const menuToggle = document.getElementById('menuToggle');
  if (menuToggle) {
    menuToggle.addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('active');
    });
  }

  // Read staff id from query param (id expected to be numeric 1..92)
  const params = new URLSearchParams(window.location.search);
  const rawId = params.get('id');
  const staffIdParam = rawId ? parseInt(rawId, 10) : NaN;

  // Load EMPLOYEES from localStorage if present, otherwise generate demo list
  function generateDemoEmployees() {
    const PROFESSORS = [
      { name: "Prof. Adeola Ogunleye", dept: "Computer Science", title: "Professor" },
      { name: "Prof. Chukwuemeka Eze", dept: "Mechanical Engineering", title: "Professor" },
      { name: "Dr. Maryam Danjuma", dept: "Education", title: "Senior Lecturer" },
      { name: "Prof. Olufunke Adebayo", dept: "Economics", title: "Professor" },
      { name: "Dr. Ibrahim Musa", dept: "Computer Science", title: "Senior Lecturer" },
      { name: "Prof. Kemi Bakare", dept: "Public Health", title: "Professor" },
      { name: "Dr. Emeka Nwankwo", dept: "Accounting", title: "Associate Professor" }
    ];
    const PHOTOS = [
      'https://randomuser.me/api/portraits/men/53.jpg',
      'https://randomuser.me/api/portraits/women/55.jpg',
      'https://randomuser.me/api/portraits/men/56.jpg',
      'https://randomuser.me/api/portraits/women/57.jpg',
      'https://randomuser.me/api/portraits/men/58.jpg',
      'https://randomuser.me/api/portraits/women/59.jpg'
    ];
    const DEPARTMENTS = [
      'IT','HR','Finance','Admin','Legal','Operations','Marketing','Registry','Research'
    ];

    return Array.from({ length: 92 }).map((_, idx) => {
      const base = PROFESSORS[idx % PROFESSORS.length];
      const id = idx + 1;
      const name = `${base.name.split(' ')[0]} ${String.fromCharCode(65 + (idx % 26))}${String.fromCharCode(65 + ((idx + 7) % 26))} ${base.name.split(' ')[1] || 'Staff'}`;
      const dept = DEPARTMENTS[idx % DEPARTMENTS.length];
      const photo = PHOTOS[idx % PHOTOS.length] + '?u=' + encodeURIComponent(name);
      return {
        id,
        fullName: name,
        university: "University of Edu",
        department: dept,
        position: base.title,
        email: `${name.toLowerCase().replace(/[^a-z]/g,'')}.${id}@university.edu`,
        phone: '+234' + (8000000000 + id).toString().slice(-10),
        photo,
        bio: `${name} is a ${base.title} in the ${dept} Department at University of Edu.`,
        history: []
      };
    });
  }

  let EMPLOYEES = [];
  try {
    const stored = localStorage.getItem('EMPLOYEES_DATA');
    EMPLOYEES = stored ? JSON.parse(stored) : [];
  } catch (e) {
    EMPLOYEES = [];
  }

  if (!Array.isArray(EMPLOYEES) || EMPLOYEES.length === 0) {
    EMPLOYEES = generateDemoEmployees();
    // persist demo data so other pages can read it
    try { localStorage.setItem('EMPLOYEES_DATA', JSON.stringify(EMPLOYEES)); } catch (e) { /* ignore */ }
  }

  // find staff by id from query param, else use first
  const staff = (!Number.isNaN(staffIdParam) && EMPLOYEES.find(e => e.id === staffIdParam)) ? EMPLOYEES.find(e => e.id === staffIdParam) : EMPLOYEES[0];

  // Populate UI (use the IDs that exist in the markup)
  if (staff) {
    const staffPhotoEl = $('staffPhoto');
    const staffNameEl = $('staffName');
    const staffDeptEl = $('staffDept');
    const staffEmailEl = $('staffEmail');
    const staffPhoneEl = $('staffPhone');
    const staffBioEl = $('staffBio');
    const rateForNameEl = $('rateForName');

    if (staffPhotoEl) staffPhotoEl.src = staff.photo || 'https://i.pravatar.cc/400?u=default';
    if (staffNameEl) staffNameEl.textContent = staff.fullName || 'Unknown';
    if (staffDeptEl) staffDeptEl.textContent = staff.department || '—';
    if (staffEmailEl) staffEmailEl.textContent = staff.email || '—';
    if (staffPhoneEl) staffPhoneEl.textContent = staff.phone || '—';
    if (staffBioEl) staffBioEl.textContent = staff.bio || 'No biography available.';
    if (rateForNameEl) rateForNameEl.textContent = staff.fullName || '—';
  }

  // Rating history rendering
  function renderHistory(historyList) {
    const tbody = $('ratingsBody');
    const historyFor = $('historyFor');
    if (!tbody) return;
    if (!Array.isArray(historyList) || historyList.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted)">No ratings yet</td></tr>';
    } else {
      tbody.innerHTML = historyList.map(h => `<tr><td>${h.date}</td><td>${h.criteria}</td><td>${h.score}</td><td>${h.comment || ''}</td></tr>`).join('');
    }
    if (historyFor) historyFor.textContent = staff.fullName || '—';
  }

  // Toggle history panel
  const viewHistoryBtn = $('viewHistoryBtn');
  const historySection = $('historySection');
  if (viewHistoryBtn && historySection) {
    viewHistoryBtn.addEventListener('click', () => {
      const isVisible = historySection.style.display === 'block';
      historySection.style.display = isVisible ? 'none' : 'block';
      viewHistoryBtn.setAttribute('aria-expanded', !isVisible ? 'true' : 'false');
      if (!isVisible) {
        renderHistory(staff.history || []);
        historySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  }

  // Open report
  const openReportBtn = $('openReportBtn');
  if (openReportBtn) {
    openReportBtn.addEventListener('click', () => {
      window.location.href = `reports.html?id=${encodeURIComponent(staff.id)}`;
    });
  }

  // Logout
  const logoutBtn = $('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', (e) => {
      // optional: clear sessionStorage/local tokens here
      window.location.href = 'index.html';
    });
  }

  // Rating submission
  const submitBtn = $('submitRatingBtn');
  const errorEl = $('errorMsg');
  const msgEl = $('ratingMsg');
  const submittedThisSession = new Set();

  function getSelectedRadioValue(name) {
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? el.value : null;
  }

  if (submitBtn) {
    submitBtn.addEventListener('click', async () => {
      if (errorEl) errorEl.style.display = 'none';
      if (msgEl) { msgEl.style.color = 'var(--muted)'; msgEl.textContent = ''; }

      const c1 = getSelectedRadioValue('c1');
      const c2 = getSelectedRadioValue('c2');
      const comment = ($('comment') && $('comment').value.trim()) || '';
      const anon = $('anon') && $('anon').checked;

      if (!c1 || !c2) {
        if (msgEl) { msgEl.style.color = '#b91c1c'; msgEl.textContent = 'Please complete all rating items.'; }
        return;
      }

      if (submittedThisSession.has(staff.id)) {
        if (errorEl) errorEl.style.display = 'block';
        return;
      }

      // Build rating entry
      const entry = {
        date: new Date().toISOString().split('T')[0],
        criteria: 'Clarity & Knowledge',
        score: ((Number(c1) + Number(c2)) / 2).toFixed(1),
        comment: comment,
        anon: !!anon,
        breakdown: [
          { criteria: 'Clarity of instruction', score: Number(c1) },
          { criteria: 'Knowledge of subject', score: Number(c2) }
        ]
      };

      // Push into staff.history and persist
      staff.history = staff.history || [];
      staff.history.unshift({
        date: entry.date,
        criteria: 'Clarity of instruction',
        score: Number(c1),
        comment
      });
      staff.history.unshift({
        date: entry.date,
        criteria: 'Knowledge of subject',
        score: Number(c2),
        comment
      });

      // Save back to EMPLOYEES array & localStorage
      const idx = EMPLOYEES.findIndex(e => e.id === staff.id);
      if (idx !== -1) {
        EMPLOYEES[idx] = staff;
        try { localStorage.setItem('EMPLOYEES_DATA', JSON.stringify(EMPLOYEES)); } catch (e) { /* ignore */ }
      }

      submittedThisSession.add(staff.id);
      if (msgEl) { msgEl.style.color = 'green'; msgEl.textContent = 'Rating submitted. Thank you.'; }

      // Update history UI if open
      if (historySection && historySection.style.display === 'block') renderHistory(staff.history || []);

      // Reset inputs
      const checkedInputs = document.querySelectorAll('input[type="radio"]:checked');
      checkedInputs.forEach(i => i.checked = false);
      if ($('comment')) $('comment').value = '';
      if ($('anon')) $('anon').checked = false;
    });
  }

  // If URL contains showHistory=1 open it automatically
  if (new URL(location.href).searchParams.get('showHistory') === '1' && viewHistoryBtn) {
    setTimeout(() => viewHistoryBtn.click(), 250);
  }
  </script>
</body>
</html>
